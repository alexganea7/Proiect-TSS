pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                sh 'g++ -o tests tests.cpp /usr/lib/libgtest.a --coverage'
            }
        }
        stage('Test') {
            steps {
                sh './tests'
            }
        }
        stage('Code Coverage') {
            steps {
                sh 'lcov --capture --filter branch --rc lcov_branch_coverage=1 --directory . --output-file coverage_output'
                sh 'genhtml -s coverage_output --branch-coverage --highlight --legend --output-directory html'
            }
            post {
                always {
                    echo 'Code coverage report available at: ${env.WORKSPACE}/coverage-report/index.html'
                }
            }
        }
    }
}
