pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                sh 'g++ -o tests tests.cpp /lib/libgtest.a --coverage'
            }
        }
        stage('Test') {
            steps {
                script {
                    def testResult = sh(returnStatus: true, script: './tests')
                    if (testResult != 0) {
                        error 'One or more tests failed'
                    }
                }
            }
        }
        stage('Code Coverage') {
            steps {
                sh 'lcov --no-external --ignore-errors mismatch --capture --directory . --rc lcov_branch_coverage=1 --filter branch --output-file coverage_output'
                sh 'genhtml -s coverage_output --branch-coverage --highlight --legend --output-directory html'
            }
            post {
                always {
                    echo 'Code coverage report available at: ${env.WORKSPACE}/html/index.html'
                }
            }
        }
    }
}
