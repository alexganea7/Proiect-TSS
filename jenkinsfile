pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                sh 'g++ -o tests tests.cpp /usr/lib/libgtest.a --coverage'
            }
        }
        stage('Test') {
            steps {
                sh './tests'
            }
        }
        stage('Code Coverage') {
            steps {
                sh 'lcov --capture --rc lcov_branch_coverage=1 --no-external --directory . --output-file coverage_output'
                sh 'genhtml -s --branch-coverage --highlight --legend --output-directory out coverage-output'
            }
            post {
                always {
                    echo 'Code coverage report available at: ${env.WORKSPACE}/coverage-report/index.html'
                }
            }
        }
    }
}
